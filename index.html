<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Folders & Pages ‚Äî Notebook-like Markdown + Code (no execution)</title>
<style>
:root{
  --sidebar-width: 300px;
  --accent: #2b6cb0;
  --muted: #f3f4f6;
  --card: #fff;
  --danger: #e53e3e;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: Inter, Roboto, Arial, sans-serif;
  height:100vh;
  display:flex;
  background: #f6f7fb;
  color:#111;
}

/* Sidebar */
#sidebar{
  width:var(--sidebar-width);
  background:var(--muted);
  border-right:1px solid #ddd;
  padding:12px;
  overflow:auto;
}
h2{margin:6px 0 12px 0;font-size:18px}
.small{font-size:13px;color:#444}

/* folder list */
.folder {
  background: #fff;
  padding:8px;
  margin-bottom:8px;
  border-radius:6px;
  border:1px solid #e6e6e6;
}
.folder-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}
.folder-title{
  font-weight:600;
  cursor:pointer;
}
.folder-actions button{
  margin-left:6px;
  padding:6px 8px;
  border-radius:6px;
  border:1px solid #ccc;
  background:white;
  cursor:pointer;
}
.pages-list{
  margin-top:8px;
  padding-left:0;
  list-style:none;
}
.page-item{
  padding:6px;
  margin-bottom:6px;
  border-radius:6px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  border:1px solid transparent;
}
.page-item:hover{background:#fbfdff}
.page-item.active{
  background: linear-gradient(90deg,#e6f0ff,#f8fbff);
  border-color:#cfe3ff;
}

/* buttons */
.btn{
  display:inline-block;
  padding:8px 10px;
  background:var(--accent);
  color:white;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-size:14px;
}
.btn.ghost{background:white;color:var(--accent);border:1px solid var(--accent)}

/* main editor */
#main{
  flex:1;
  padding:18px;
  overflow:auto;
}
.editor-top{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:12px;
}
.title-input{
  font-size:20px;
  padding:8px 10px;
  border-radius:8px;
  border:1px solid #ccc;
  background:white;
  width:60%;
}

/* Page area card */
.page-card{
  background:var(--card);
  border-radius:10px;
  padding:14px;
  box-shadow:0 2px 6px rgba(20,20,40,0.04);
  min-height:200px;
}

/* cells */
.cell{
  border:1px solid #e6e7eb;
  border-radius:8px;
  padding:8px;
  margin-bottom:12px;
  background:white;
}
.cell-controls{
  display:flex;
  justify-content:space-between;
  gap:8px;
  align-items:center;
  margin-bottom:8px;
  font-size:13px;
}
.cell-controls .left, .cell-controls .right {display:flex;gap:6px;align-items:center}
.small-muted{color:#666;font-size:13px}

/* markdown editor and preview */
.md-editor, .code-editor, .md-preview {
  width:100%;
  border-radius:6px;
  padding:8px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
  font-size:14px;
  box-sizing:border-box;
}
.md-editor{min-height:80px;border:1px dashed #d0d4da; resize:vertical}
.code-editor{min-height:80px;border:1px solid #dfe6ef; background:#f7f9fc; resize:vertical}
.md-preview{min-height:40px;border:1px solid #f0f2f6;background:#fff}

/* cell buttons */
.cc-btn{
  padding:6px 8px;border-radius:6px;border:1px solid #ccc;background:white;cursor:pointer;font-size:13px
}
.cc-btn.warn{border-color:var(--danger);color:var(--danger)}

/* helper small UI */
.controls-row{display:flex;gap:8px;align-items:center}
.sep{height:24px;border-left:1px solid #eee;margin:0 8px}

/* mobile responsiveness */
@media(max-width:900px){
  #sidebar{display:none}
}
</style>
</head>
<body>

<!-- SIDEBAR: –ø–∞–ø–∫–∏ –∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<div id="sidebar">
  <h2>–ü–∞–ø–∫–∏ –∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h2>
  <div class="small">–ü–∞–ø–∫–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–µ–∫—Å—Ç–∞. –í –ø–∞–ø–∫–∞—Ö —Å–æ–∑–¥–∞—é—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∫–æ–Ω–µ—á–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã).</div>
  <div style="height:12px"></div>

  <div id="foldersList"></div>

  <div style="height:12px"></div>
  <button id="createFolderBtn" class="btn">–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</button>
  <div style="height:8px"></div>
  <button id="createPageInFolderBtn" class="btn ghost">–°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ</button>
  <div style="height:10px"></div>
  <button id="exportBtn" class="btn ghost">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë (JSON)</button>
  <div style="height:8px"></div>
  <button id="importBtn" class="btn ghost">–ò–º–ø–æ—Ä—Ç (–∑–∞–º–µ–Ω–∏—Ç –ª–æ–∫–∞–ª—å–Ω–æ)</button>
  <input type="file" id="importFile" style="display:none" accept="application/json" />
</div>

<!-- MAIN: —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<div id="main">
  <div class="editor-top">
    <input id="pageTitle" class="title-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã" />
    <div class="controls-row">
      <button id="addMdCellBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å Markdown</button>
      <button id="addCodeCellBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å Code</button>
      <div class="sep"></div>
      <button id="savePageBtn" class="btn ghost">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="deletePageBtn" class="cc-btn warn">–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
    </div>
  </div>

  <div class="page-card">
    <div id="cellsContainer"></div>
    <div style="height:8px"></div>
    <div class="small-muted">–Ø—á–µ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ. –ö–æ–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è ‚Äî –≤—ã–≤–æ–¥ –æ—Ç–∫–ª—é—á—ë–Ω.</div>
  </div>
</div>

<script>
/* ========== Data model ==========
folders: array of {id, title, pages: [pageId,...]}
pages: map pageId -> {id, title, cells: [{type: 'md'|'code', content: ''}, ...]}
All stored as single object in localStorage under key "notebook_v1"
=================================*/

const STORAGE_KEY = "notebook_v1_v2";

/* ----- load/save ----- */
function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) {
    // seed one default folder + page
    const idF = uid("folder");
    const idP = uid("page");
    const state = {
      folders: [
        {id:idF, title:"Default", pages:[idP]}
      ],
      pages: {
        [idP]: {id:idP, title:"–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞", cells:[
          {type:"md", content:"# –ü—Ä–∏–≤–µ—Ç\n\n–≠—Ç–æ **markdown** —è—á–µ–π–∫–∞."},
          {type:"code", content:"# –ø—Ä–∏–º–µ—Ä –∫–æ–¥–∞\nprint('Hello')"}
        ]}
      },
      current: {folderId: idF, pageId: idP}
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    return state;
  }
  try {
    return JSON.parse(raw);
  } catch(e){
    console.error("parse error", e);
    return {folders:[], pages:{}, current:{}};
  }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* ----- utilities ----- */
function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(36).slice(2,10);
}

/* ----- simple markdown renderer (basic) ----- */
/* supports headings #, ##, bold **text**, italic *text*, inline `code`, fenced code blocks ```lang\n...\n``` and lists -, numbers, links [text](url) */
function renderMarkdown(md){
  // escape html
  // –≠–∫—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –∞–º–ø–µ—Ä—Å–∞–Ω–¥, –Ω–æ –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å HTML
let s = md.replace(/&(?!(?:[a-z]+;|#\d+;))/gi, "&amp;");

  // code fences
  s = s.replace(/```([\s\S]*?)```/g, (m, code)=> {
    return '<pre class="md-code-block" style="background:#0b1220;color:#fff;padding:8px;border-radius:6px;overflow:auto"><code>' + code.replace(/&/g,"&amp;").replace(/</g,"&lt;") + '</code></pre>';
  });
  // headings
  s = s.replace(/^###### (.*$)/gm,'<h6>$1</h6>');
  s = s.replace(/^##### (.*$)/gm,'<h5>$1</h5>');
  s = s.replace(/^#### (.*$)/gm,'<h4>$1</h4>');
  s = s.replace(/^### (.*$)/gm,'<h3>$1</h3>');
  s = s.replace(/^## (.*$)/gm,'<h2>$1</h2>');
  s = s.replace(/^# (.*$)/gm,'<h1>$1</h1>');
  // bold and italic
  s = s.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
  s = s.replace(/\*(.*?)\*/g,'<em>$1</em>');
  // inline code
  s = s.replace(/`([^`]+)`/g,'<code style="background:#f1f3f5;padding:2px 6px;border-radius:4px;">$1</code>');
  // links
  s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
  // unordered lists
  s = s.replace(/^\s*-\s+(.*)$/gm,'<li>$1</li>');
  s = s.replace(/(<li>[\s\S]*?<\/li>)/g,'<ul>$1</ul>');
  // paragraphs (remaining lines)
  s = s.replace(/^\s*([\s\S]*?)\s*$/gm, function(match, line){
    if (/^<h|^<ul|^<pre|^<li|^<code|^<img/.test(line)) return line;
    if (line.trim()==="") return "";
    return "<p>"+line+"</p>";
  });
  return s;
}

/* ----- state ----- */
let state = loadState();

/* ----- DOM refs ----- */
const foldersListEl = document.getElementById("foldersList");
const pageTitleInput = document.getElementById("pageTitle");
const cellsContainer = document.getElementById("cellsContainer");
const addMdCellBtn = document.getElementById("addMdCellBtn");
const addCodeCellBtn = document.getElementById("addCodeCellBtn");
const savePageBtn = document.getElementById("savePageBtn");
const deletePageBtn = document.getElementById("deletePageBtn");
const createFolderBtn = document.getElementById("createFolderBtn");
const createPageInFolderBtn = document.getElementById("createPageInFolderBtn");
const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");
const importFile = document.getElementById("importFile");

/* ----- render sidebar (folders -> pages) ----- */
function renderSidebar(){
  foldersListEl.innerHTML = "";
  state.folders.forEach(folder=>{
    const fEl = document.createElement("div");
    fEl.className = "folder";
    // header
    const header = document.createElement("div");
    header.className = "folder-header";

    const left = document.createElement("div");
    left.style.display="flex";
    left.style.flexDirection="column";
    const title = document.createElement("div");
    title.className="folder-title";
    title.textContent = folder.title;
    title.onclick = () => { state.current.folderId = folder.id; // select folder
                           // if folder has at least one page, select first page if none selected
                           if (!state.current.pageId && folder.pages && folder.pages.length) state.current.pageId = folder.pages[0];
                           saveState(); renderSidebar(); renderPage(); };
    left.appendChild(title);
    const small = document.createElement("div");
    small.className="small";
    small.textContent = folder.pages.length + " —Å—Ç—Ä–∞–Ω–∏—Ü";
    left.appendChild(small);

    header.appendChild(left);

    const actions = document.createElement("div");
    actions.className = "folder-actions";

    const renameBtn = document.createElement("button");
    renameBtn.textContent = "–ü–µ—Ä–µ–∏–º–µ–Ω";
    renameBtn.onclick = (e)=> {
      e.stopPropagation();
      const n = prompt("–ù–æ–≤–æ–µ –∏–º—è –ø–∞–ø–∫–∏:", folder.title);
      if (!n) return;
      folder.title = n;
      saveState();
      renderSidebar();
    };
    actions.appendChild(renameBtn);

    const delBtn = document.createElement("button");
    delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
    delBtn.onclick = (e)=> {
      e.stopPropagation();
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É –∏ –≤—Å–µ –µ—ë —Å—Ç—Ä–∞–Ω–∏—Ü—ã?")) return;
      // remove pages from pages map
      folder.pages.forEach(pid => delete state.pages[pid]);
      // remove folder
      state.folders = state.folders.filter(f=>f.id!==folder.id);
      // clear current if needed
      if (state.current.folderId === folder.id) state.current.folderId = state.folders[0]?.id || null;
      if (state.current.pageId && !state.pages[state.current.pageId]) state.current.pageId = null;
      saveState();
      renderSidebar(); renderPage();
    };
    actions.appendChild(delBtn);

    header.appendChild(actions);

    fEl.appendChild(header);

    // pages list
    const ul = document.createElement("ul");
    ul.className = "pages-list";
    folder.pages.forEach(pid=>{
      const p = state.pages[pid];
      const li = document.createElement("li");
      li.className = "page-item" + ((state.current.pageId===pid) ? " active":"");
      const leftPart = document.createElement("div");
      leftPart.style.display="flex";
      leftPart.style.alignItems="center";
      leftPart.style.gap="8px";
      const icon = document.createElement("span"); icon.textContent="üìÑ";
      const ttl = document.createElement("span"); ttl.textContent = p?.title || "(—É–¥–∞–ª–µ–Ω–∞)";
      leftPart.appendChild(icon); leftPart.appendChild(ttl);
      li.appendChild(leftPart);

      const rightPart = document.createElement("div");
      rightPart.style.display="flex"; rightPart.style.gap="6px";

      // open/select
      li.onclick = ()=> {
        state.current.folderId = folder.id;
        state.current.pageId = pid;
        saveState();
        renderSidebar();
        renderPage();
      };

      // rename page
      const rbtn = document.createElement("button"); rbtn.textContent="R";
      rbtn.title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å";
      rbtn.onclick = (e)=> { e.stopPropagation();
        const n = prompt("–ù–æ–≤–æ–µ –∏–º—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã:", p.title);
        if (!n) return;
        p.title = n;
        saveState(); renderSidebar(); renderPage(); };
      rightPart.appendChild(rbtn);

      // delete page
      const dbtn = document.createElement("button"); dbtn.textContent="X"; dbtn.title="–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É";
      dbtn.onclick = (e)=> { e.stopPropagation();
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?")) return;
        // remove page id from folder
        folder.pages = folder.pages.filter(x=>x!==pid);
        delete state.pages[pid];
        if (state.current.pageId === pid) state.current.pageId = null;
        saveState(); renderSidebar(); renderPage();
      };
      rightPart.appendChild(dbtn);

      li.appendChild(rightPart);

      ul.appendChild(li);
    });
    fEl.appendChild(ul);

    foldersListEl.appendChild(fEl);
  });
}

/* ----- render page editor ----- */
function renderPage(){
  const pid = state.current.pageId;
  if (!pid){
    pageTitleInput.value = "";
    cellsContainer.innerHTML = "<div class='small-muted'>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é.</div>";
    return;
  }
  const page = state.pages[pid];
  if (!page) {
    pageTitleInput.value = "";
    cellsContainer.innerHTML = "<div class='small-muted'>–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</div>";
    return;
  }
  pageTitleInput.value = page.title || "";

  // render cells
  cellsContainer.innerHTML = "";
  page.cells.forEach((cell, idx)=>{
    const cellEl = document.createElement("div"); cellEl.className="cell";
    // controls
    const controls = document.createElement("div"); controls.className="cell-controls";
    const left = document.createElement("div"); left.className="left";
    left.innerHTML = `<div class="small-muted">${cell.type === 'md' ? 'Markdown' : 'Code'}</div>`;
    controls.appendChild(left);
    const right = document.createElement("div"); right.className="right";

    const upBtn = document.createElement("button"); upBtn.className="cc-btn"; upBtn.textContent="‚Üë"; upBtn.title="–í–≤–µ—Ä—Ö";
    upBtn.onclick = ()=> { if (idx===0) return; swapCells(page, idx, idx-1); renderPage(); saveState();}
    right.appendChild(upBtn);

    const downBtn = document.createElement("button"); downBtn.className="cc-btn"; downBtn.textContent="‚Üì"; downBtn.title="–í–Ω–∏–∑";
    downBtn.onclick = ()=> { if (idx===page.cells.length-1) return; swapCells(page, idx, idx+1); renderPage(); saveState();}
    right.appendChild(downBtn);

    const addBelowBtn = document.createElement("button"); addBelowBtn.className="cc-btn"; addBelowBtn.textContent="+"; addBelowBtn.title="–î–æ–±–∞–≤–∏—Ç—å –Ω–∏–∂–µ";
    addBelowBtn.onclick = ()=> { insertCell(page, idx+1, {type:'md', content:''}); renderPage(); saveState(); }
    right.appendChild(addBelowBtn);

    const delBtn = document.createElement("button"); delBtn.className="cc-btn warn"; delBtn.textContent="–£–¥–∞–ª–∏—Ç—å"; delBtn.title="–£–¥–∞–ª–∏—Ç—å —è—á–µ–π–∫—É";
    delBtn.onclick = ()=> { if (!confirm("–£–¥–∞–ª–∏—Ç—å —è—á–µ–π–∫—É?")) return; page.cells.splice(idx,1); renderPage(); saveState(); }
    right.appendChild(delBtn);

    controls.appendChild(right);
    cellEl.appendChild(controls);

    // body
    if (cell.type === 'md'){
      // two-mode: preview + edit toggled by button
      const preview = document.createElement("div"); preview.className="md-preview";
      preview.innerHTML = renderMarkdown(cell.content || "");
      cellEl.appendChild(preview);

      const editArea = document.createElement("textarea");
      editArea.className="md-editor";
      editArea.value = cell.content || "";
      editArea.style.display="none";
      cellEl.appendChild(editArea);

      const editBtn = document.createElement("button"); editBtn.className="cc-btn"; editBtn.textContent="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
      editBtn.onclick = ()=> {
        const showEdit = editArea.style.display === "none";
        editArea.style.display = showEdit ? "block" : "none";
        preview.style.display = showEdit ? "none" : "block";
        editBtn.textContent = showEdit ? "–ü—Ä–æ—Å–º–æ—Ç—Ä" : "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
      };
      const renderNowBtn = document.createElement("button"); renderNowBtn.className="cc-btn"; renderNowBtn.textContent="–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é";
      renderNowBtn.onclick = ()=> { cell.content = editArea.value; preview.innerHTML = renderMarkdown(cell.content); saveState(); };

      // auto-save on input (but only if editing)
      editArea.addEventListener("input", ()=> {
        cell.content = editArea.value;
        // preview not updated until user clicks update (like Jupyter)
      });

      const btns = document.createElement("div"); btns.style.marginTop="8px";
      btns.appendChild(editBtn);
      btns.appendChild(renderNowBtn);
      cellEl.appendChild(btns);
    } else {
      // code cell
      const ta = document.createElement("textarea");
      ta.className="code-editor";
      ta.value = cell.content || "";
      ta.addEventListener("input", ()=> { cell.content = ta.value; saveState(); });
      cellEl.appendChild(ta);

      // we intentionally DO NOT provide run/execute
      const note = document.createElement("div"); note.className="small-muted"; note.style.marginTop="6px";
      note.textContent = "–ö–æ–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (–≤—ã–≤–æ–¥ –æ—Ç–∫–ª—é—á—ë–Ω).";
      cellEl.appendChild(note);
    }

    cellsContainer.appendChild(cellEl);
  });

  // add small footer to add new cells
  const footer = document.createElement("div"); footer.style.marginTop="8px";
  const addMd = document.createElement("button"); addMd.className="cc-btn"; addMd.textContent="–î–æ–±–∞–≤–∏—Ç—å Markdown –≤ –∫–æ–Ω–µ—Ü";
  addMd.onclick = ()=> { insertCell(page, page.cells.length, {type:'md', content:''}); renderPage(); saveState(); };
  const addCode = document.createElement("button"); addCode.className="cc-btn"; addCode.textContent="–î–æ–±–∞–≤–∏—Ç—å Code –≤ –∫–æ–Ω–µ—Ü";
  addCode.onclick = ()=> { insertCell(page, page.cells.length, {type:'code', content:''}); renderPage(); saveState(); };
  footer.appendChild(addMd); footer.appendChild(addCode);
  cellsContainer.appendChild(footer);
}

/* ----- helper functions for cells ----- */
function swapCells(page, i, j){
  const tmp = page.cells[i];
  page.cells[i] = page.cells[j];
  page.cells[j] = tmp;
}
function insertCell(page, idx, cell){
  page.cells.splice(idx,0,cell);
}

/* ----- UI events ----- */
addMdCellBtn.onclick = ()=>{
  const pid = state.current.pageId;
  if (!pid){ alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É."); return; }
  const page = state.pages[pid];
  page.cells.push({type:'md', content:''});
  saveState(); renderPage();
};
addCodeCellBtn.onclick = ()=>{
  const pid = state.current.pageId;
  if (!pid){ alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É."); return; }
  const page = state.pages[pid];
  page.cells.push({type:'code', content:''});
  saveState(); renderPage();
};

savePageBtn.onclick = ()=>{
  const pid = state.current.pageId;
  if (!pid) return alert("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞");
  const page = state.pages[pid];
  page.title = pageTitleInput.value || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
  saveState(); renderSidebar(); renderPage();
  alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
};

deletePageBtn.onclick = ()=>{
  const pid = state.current.pageId;
  if (!pid) return alert("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞");
  if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?")) return;
  // remove from folder
  const folder = state.folders.find(f=>f.id === state.current.folderId);
  if (folder) folder.pages = folder.pages.filter(p=>p!==pid);
  delete state.pages[pid];
  state.current.pageId = folder?.pages[0] || null;
  saveState(); renderSidebar(); renderPage();
};

createFolderBtn.onclick = ()=>{
  const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏:");
  if (!name) return;
  const id = uid("folder");
  state.folders.push({id, title:name, pages:[]});
  state.current.folderId = id;
  saveState(); renderSidebar(); renderPage();
};

createPageInFolderBtn.onclick = ()=>{
  const fid = state.current.folderId;
  if (!fid){
    alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –ø–∞–ø–∫—É –∏–ª–∏ —Å–æ–∑–¥–∞–π –Ω–æ–≤—É—é.");
    return;
  }
  const folder = state.folders.find(f=>f.id===fid);
  if (!folder) return alert("–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
  const pageId = uid("page");
  const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã:","–ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞");
  state.pages[pageId] = {id:pageId, title: title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è", cells:[]};
  folder.pages.push(pageId);
  state.current.pageId = pageId;
  saveState(); renderSidebar(); renderPage();
};

exportBtn.onclick = ()=>{
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "notebook_export.json";
  a.click();
  URL.revokeObjectURL(url);
};

importBtn.onclick = ()=> importFile.click();
importFile.onchange = (e)=>{
  const f = e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = (ev)=> {
    try {
      const parsed = JSON.parse(ev.target.result);
      if (!confirm("–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ?")) return;
      state = parsed;
      saveState();
      renderSidebar(); renderPage();
      alert("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω");
    } catch(err){ alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: "+err); }
  };
  reader.readAsText(f);
};

/* ----- initial rendering ----- */
function ensureStateFields(){
  if (!state.folders) state.folders = [];
  if (!state.pages) state.pages = {};
  if (!state.current) state.current = {folderId: state.folders[0]?.id || null, pageId: state.folders[0]?.pages?.[0] || null};
}
ensureStateFields();
renderSidebar();
renderPage();

/* ----- auto-save title edit ----- */
pageTitleInput.addEventListener("input", ()=> {
  const pid = state.current.pageId;
  if (!pid) return;
  state.pages[pid].title = pageTitleInput.value;
  saveState();
  renderSidebar();
});

/* make sidebar re-render when switching etc. */
function saveState(){
  saveStateInternal();
}
function saveStateInternal(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* alias to previously used functions */
function saveState(){ saveStateInternal(); }

/* ensure exported functions available for debugging */
window._nb_state = state;
</script>

</body>
</html>

