<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width">
<title>Folders + Markdown Pages</title>

<style>
body {
    margin: 0;
    font-family: "Roboto", sans-serif;
    display: flex;
    height: 100vh;
}

/* Sidebar */
#sidebar {
    width: 260px;
    background: #f0f0f0;
    border-right: 2px solid #ccc;
    padding: 10px;
    overflow-y: auto;
}

.item {
    padding: 6px;
    margin: 3px 0;
    user-select: none;
}

.item.active {
    background: #bbb;
    border-radius: 6px;
    font-weight: bold;
}

.children {
    margin-left: 20px;
    border-left: 1px dashed #aaa;
    padding-left: 10px;
}

/* Editor */
#editor {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 15px;
}

#mdInput {
    width: 100%;
    height: 40%;
    padding: 10px;
    font-size: 16px;
    border: 2px dashed #aaa;
    border-radius: 10px;
    resize: none;
}

#preview {
    flex: 1;
    padding: 10px;
    margin-top: 10px;
    border: 1px solid #aaa;
    border-radius: 10px;
    overflow-y: auto;
    background: #fff;
}

/* Buttons */
button {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}
</style>
</head>

<body>

<!-- LEFT SIDEBAR -->
<div id="sidebar">
    <h3>–°—Ç—Ä—É–∫—Ç—É—Ä–∞</h3>

    <div id="tree"></div>

    <button id="btnNewFolder">–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</button>
    <button id="btnNewPage">–°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
</div>

<!-- RIGHT EDITOR -->
<div id="editor">
    <textarea id="mdInput" placeholder="Markdown..."></textarea>
    <div id="preview"></div>
</div>

<script>
// === DATA MODEL ===
// folders = { id: { id, title, type:"folder", children:[...] } }
// pages   = { id: { id, title, type:"page", markdown:"..." } }

let root = JSON.parse(localStorage.getItem("treeData")) || [];
let currentId = null;

// === SAVE ===
function save() {
    localStorage.setItem("treeData", JSON.stringify(root));
}

// === ID ===
function uid() {
    return "id_" + Math.random().toString(36).substr(2, 9);
}

// === RENDER TREE ===
function renderTree() {
    const container = document.getElementById("tree");
    container.innerHTML = "";

    const renderNode = (node, parent) => {
        let div = document.createElement("div");
        div.className = "item";
        div.textContent = (node.type === "folder" ? "üìÅ " : "üìÑ ") + node.title;
        if (node.id === currentId) div.classList.add("active");
        div.onclick = () => selectNode(node.id);

        parent.appendChild(div);

        if (node.type === "folder" && node.children) {
            let ch = document.createElement("div");
            ch.className = "children";
            parent.appendChild(ch);
            node.children.forEach(child => renderNode(child, ch));
        }
    };

    root.forEach(node => renderNode(node, container));
}

// === FIND NODE ===
function findNodeById(id, list = root) {
    for (let node of list) {
        if (node.id === id) return node;
        if (node.type === "folder") {
            let found = findNodeById(id, node.children);
            if (found) return found;
        }
    }
    return null;
}

// === SELECT NODE ===
function selectNode(id) {
    currentId = id;
    const node = findNodeById(id);

    if (node.type === "page") {
        document.getElementById("mdInput").disabled = false;
        document.getElementById("mdInput").value = node.markdown;
        renderMarkdown(node.markdown);
    } else {
        document.getElementById("mdInput").value = "";
        document.getElementById("mdInput").disabled = true;
        document.getElementById("preview").innerHTML = "<i>–≠—Ç–æ –ø–∞–ø–∫–∞. –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</i>";
    }

    renderTree();
}

// === CREATE FOLDER ===
document.getElementById("btnNewFolder").onclick = () => {
    let title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏:");
    if (!title) return;

    let f = {
        id: uid(),
        title,
        type: "folder",
        children: []
    };

    if (!currentId) {
        root.push(f);
    } else {
        let parent = findNodeById(currentId);
        if (parent.type !== "folder") {
            alert("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã.");
            return;
        }
        parent.children.push(f);
    }

    save();
    renderTree();
};

// === CREATE PAGE ===
document.getElementById("btnNewPage").onclick = () => {
    let title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:");
    if (!title) return;

    let p = {
        id: uid(),
        title,
        type: "page",
        markdown: ""
    };

    if (!currentId) {
        root.push(p);
    } else {
        let parent = findNodeById(currentId);
        if (parent.type !== "folder") {
            alert("–°—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ–ª—å–∑—è –≤–∫–ª–∞–¥—ã–≤–∞—Ç—å –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.");
            return;
        }
        parent.children.push(p);
    }

    save();
    renderTree();
};

// === SIMPLE MARKDOWN PARSER ===
function renderMarkdown(md) {
    let html = md
        .replace(/^### (.*$)/gim, "<h3>$1</h3>")
        .replace(/^## (.*$)/gim, "<h2>$1</h2>")
        .replace(/^# (.*$)/gim, "<h1>$1</h1>")
        .replace(/\*\*(.*)\*\*/gim, "<b>$1</b>")
        .replace(/\*(.*)\*/gim, "<i>$1</i>")
        .replace(/`([^`]+)`/gim, "<code>$1</code>")
        .replace(/\n/gim, "<br>");

    document.getElementById("preview").innerHTML = html;
}

// === AUTOSAVE MD ===
document.getElementById("mdInput").addEventListener("input", () => {
    let node = findNodeById(currentId);
    if (!node || node.type !== "page") return;

    node.markdown = document.getElementById("mdInput").value;
    save();
    renderMarkdown(node.markdown);
});

// === INITIAL RENDER ===
renderTree();
document.getElementById("mdInput").disabled = true;
</script>

</body>
</html>
